---
phase: 06-polish-launch
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/scanner/paths.test.ts
  - src/permissions/resolver.test.ts
  - src/health/resolver.test.ts
  - .github/workflows/ci.yml
autonomous: true

must_haves:
  truths:
    - "All existing tests pass on current platform"
    - "Core resolvers have unit test coverage"
    - "CI pipeline runs tests on push and PR events"
    - "CI tests across Windows, macOS, and Linux"
  artifacts:
    - path: "src/scanner/paths.test.ts"
      provides: "Scanner path resolution tests"
      min_lines: 30
    - path: "src/permissions/resolver.test.ts"
      provides: "Permission merge logic tests"
      min_lines: 40
    - path: "src/health/resolver.test.ts"
      provides: "Health scoring algorithm tests"
      min_lines: 40
    - path: ".github/workflows/ci.yml"
      provides: "Cross-platform CI pipeline"
      contains: "matrix"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "npm test"
      via: "CI test step"
      pattern: "npm test"
    - from: ".github/workflows/ci.yml"
      to: "npm run build"
      via: "CI build step"
      pattern: "npm run build"
---

<objective>
Add unit tests for core resolver modules and set up GitHub Actions CI with cross-platform testing.

Purpose: Ensure code quality and cross-platform reliability before npm publish.
Output: 3 new test files covering critical resolvers + GitHub Actions workflow running on Windows/macOS/Linux.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/scanner/paths.ts
@src/scanner/types.ts
@src/permissions/resolver.ts
@src/permissions/types.ts
@src/health/resolver.ts
@src/health/types.ts
@src/settings/resolver.test.ts
@vitest.config.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add unit tests for core resolvers</name>
  <files>src/scanner/paths.test.ts, src/permissions/resolver.test.ts, src/health/resolver.test.ts</files>
  <action>
    Create three test files following the existing pattern in src/settings/resolver.test.ts (vitest, describe/it blocks, globals enabled).

    **src/scanner/paths.test.ts** — Test `getConfigPaths()` and `getGlobalClaudeDir()`:
    - Without projectDir: returns only global/user-scope expectations (managed settings, user settings, credentials, keybindings, CLAUDE.md, commands-dir)
    - With projectDir: returns global + project-scope expectations (project settings, local settings, project CLAUDE.md files, commands-dir, .mcp.json)
    - Verify expected scope values (managed, user, project, local) are correct for each entry
    - Verify expected types (settings, credentials, keybindings, claude-md, commands-dir, mcp)
    - Verify paths contain the expected directory segments (e.g., ".claude" in user paths, projectDir in project paths)

    **src/permissions/resolver.test.ts** — Test `resolvePermissions()`:
    - Create mock ConfigFile objects with permissions content for different scopes
    - Single scope: permissions from one file apply directly
    - Deny always wins: if any scope has "deny" for a tool, result is "deny" regardless of other scopes having "allow"
    - Scope priority: when no deny, higher scope (local > project > user) wins
    - Ask > allow: "ask" beats "allow" at same priority level
    - Empty permissions: returns empty result
    - Mixed tools: different tools get independent resolution
    - Origin tracking: each resolved permission shows which scope it came from

    **src/health/resolver.test.ts** — Test `computeHealth()`:
    - Create mock ScanResult objects with varying completeness
    - Full config: all files present → high score (A grade, 90+)
    - Minimal config: only required files → lower score
    - Grade thresholds: verify A (90+), B (75-89), C (60-74), D (40-59), F (<40) boundaries
    - Category weights: Memory (30%), Settings (25%), MCP (20%), Hooks (15%), Permissions (10%)
    - Recommendations: missing config → recommendations array includes suggestion
    - Empty scan result: produces valid (low) score without crashing

    Use `describe()` and `it()` blocks. Import types from adjacent types.ts files. Mock data inline (no external fixtures).
  </action>
  <verify>npx vitest run — all tests pass (existing settings tests + 3 new test files)</verify>
  <done>3 test files created with 5-8 tests each, all passing alongside existing settings resolver tests</done>
</task>

<task type="auto">
  <name>Task 2: Create GitHub Actions CI workflow</name>
  <files>.github/workflows/ci.yml</files>
  <action>
    Create `.github/workflows/ci.yml` with:

    **Trigger:** push to main/master, pull_request to main/master

    **Matrix:**
    - os: [ubuntu-latest, windows-latest, macos-latest]
    - node: [18, 20, 22]

    **Steps:**
    1. Checkout code
    2. Setup Node.js (use actions/setup-node@v4 with node-version from matrix)
    3. Install dependencies: `npm ci`
    4. Type check: `npm run typecheck`
    5. Run tests: `npm test`
    6. Build: `npm run build`
    7. Verify CLI runs: `node dist/index.js --help`

    **Notes:**
    - Use `npm ci` not `npm install` for reproducible builds in CI
    - Cache npm dependencies with actions/setup-node built-in caching (cache: 'npm')
    - Set `fail-fast: false` on matrix so all platforms report even if one fails
    - Name the workflow "CI"
  </action>
  <verify>cat .github/workflows/ci.yml — valid YAML with matrix strategy, 3 OS, 3 Node versions, all required steps</verify>
  <done>CI workflow file exists at .github/workflows/ci.yml with cross-platform matrix testing</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx vitest run` passes all tests (existing + new)
- [ ] `npm run typecheck` passes
- [ ] `npm run build` succeeds
- [ ] `.github/workflows/ci.yml` is valid YAML
- [ ] CI workflow covers Windows, macOS, Linux
- [ ] CI workflow covers Node.js 18, 20, 22
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- 3 new test files with meaningful coverage of core resolvers
- CI workflow ready to run on first push to GitHub
</success_criteria>

<output>
After completion, create `.planning/phases/06-polish-launch/06-01-SUMMARY.md`
</output>
