---
phase: 05-advanced-features
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/workspace/types.ts
  - src/workspace/discovery.ts
  - src/workspace/comparison.ts
  - src/commands/compare.ts
  - src/formatters/compare.ts
  - src/formatters/index.ts
  - src/server/routes.ts
  - src/index.ts
autonomous: true

must_haves:
  truths:
    - "User can discover all Claude Code projects under a parent directory"
    - "User can compare configuration across two or more projects side-by-side"
    - "Comparison shows what's different between projects (settings, MCP servers, hooks, permissions)"
    - "User can see which projects have CLAUDE.md and which don't"
  artifacts:
    - path: "src/workspace/types.ts"
      provides: "ProjectInfo, WorkspaceScan, ComparisonResult types"
      min_lines: 20
    - path: "src/workspace/discovery.ts"
      provides: "Project discovery by walking parent directory"
      min_lines: 30
    - path: "src/workspace/comparison.ts"
      provides: "Cross-project comparison logic"
      min_lines: 60
  key_links:
    - from: "src/workspace/discovery.ts"
      to: "src/scanner/index.ts"
      via: "Calls scan() for each discovered project"
      pattern: "scan\\("
    - from: "src/server/routes.ts"
      to: "src/workspace/discovery.ts"
      via: "GET /api/projects endpoint"
      pattern: "api/projects"
    - from: "src/server/routes.ts"
      to: "src/workspace/comparison.ts"
      via: "GET /api/compare endpoint"
      pattern: "api/compare"
---

<objective>
Build multi-project discovery and cross-project comparison features. Users can point at a parent directory to discover all Claude Code projects and compare their configurations side-by-side.

Purpose: Users with many projects (e.g., `d:\git_repo\*`) want to see which ones are configured, what's different, and where gaps exist. This completes CONF-06.
Output: New `src/workspace/` module with discovery + comparison, new CLI `compare` command, new API endpoints.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/scanner/types.ts
@src/scanner/index.ts
@src/scanner/paths.ts
@src/server/routes.ts
@src/index.ts
@src/formatters/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create workspace discovery and comparison engine</name>
  <files>src/workspace/types.ts, src/workspace/discovery.ts, src/workspace/comparison.ts</files>
  <action>
    1. Create `src/workspace/types.ts`:
       ```typescript
       interface ProjectInfo {
         path: string;
         name: string;              // basename of directory
         hasClaudeDir: boolean;     // has .claude/ directory
         hasClaudeMd: boolean;      // has CLAUDE.md at root
         hasMcpJson: boolean;       // has .mcp.json
         configFileCount: number;   // how many config files exist
       }

       interface WorkspaceScan {
         parentDir: string;
         projects: ProjectInfo[];
         totalProjects: number;
         configuredProjects: number; // projects with at least one config file
       }

       interface ComparisonEntry {
         key: string;               // setting key, server name, etc.
         type: "setting" | "mcp" | "hook" | "permission" | "memory";
         values: Record<string, unknown>;  // projectName -> value (undefined if not present)
       }

       interface ComparisonResult {
         projects: string[];        // project names being compared
         projectPaths: string[];    // full paths
         entries: ComparisonEntry[];
         summary: {
           totalDifferences: number;
           uniqueToProject: Record<string, number>; // projectName -> count of unique items
         };
       }
       ```

    2. Create `src/workspace/discovery.ts`:
       - Export `discoverProjects(parentDir: string): Promise<WorkspaceScan>`
       - Read entries of parentDir with `fs.readdir(parentDir, { withFileTypes: true })`
       - Filter for directories (skip hidden dirs starting with `.`, `node_modules`)
       - For each directory, check:
         - Exists: `.claude/` subdir → hasClaudeDir
         - Exists: `CLAUDE.md` → hasClaudeMd
         - Exists: `.mcp.json` → hasMcpJson
       - Only include projects that have at least ONE Claude Code indicator (hasClaudeDir OR hasClaudeMd OR hasMcpJson)
       - Sort by name alphabetically
       - Return WorkspaceScan with counts

       Design notes:
       - Do NOT run full scan() for each project during discovery (too slow for many projects)
       - Discovery is lightweight: just check for indicator files
       - Full scan happens only when comparing specific projects

    3. Create `src/workspace/comparison.ts`:
       - Export `compareProjects(projectPaths: string[]): Promise<ComparisonResult>`
       - For each project path, run `scan()` then extract:
         - Settings: resolveSettings → list of key-value pairs
         - MCP servers: extractMcpServers → server names
         - Hooks: extractHooks → configured events
         - Permissions: resolvePermissions → effective rules
         - Memory: CLAUDE.md existence and size
       - Build comparison matrix:
         - For each unique key across all projects, record which projects have it and what value
       - Compute summary:
         - Total differences: entries where not all projects agree
         - Unique to project: count of items only in that project

       Design notes:
       - Comparison runs scan() for each project in parallel (Promise.all)
       - Limit to reasonable number of projects (max 10) to avoid memory issues
       - Use existing resolvers — don't re-implement extraction logic
       - Import resolvers: resolveSettings, extractMcpServers, extractHooks, resolvePermissions
  </action>
  <verify>
    `npm run build` succeeds.
    `discoverProjects` and `compareProjects` are exported.
    Types are importable from `src/workspace/types.ts`.
  </verify>
  <done>
    Workspace discovery finds Claude Code projects under a parent directory.
    Comparison engine produces side-by-side diff of project configurations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire to CLI command and API endpoints</name>
  <files>src/commands/compare.ts, src/formatters/compare.ts, src/formatters/index.ts, src/server/routes.ts, src/index.ts</files>
  <action>
    1. Create `src/commands/compare.ts`:
       - Register `compare <parent-dir-or-projects...>` command
       - If single argument and is a directory with subdirectories: run discovery, then compare all discovered projects
       - If multiple arguments: treat each as a project path, compare them directly
       - Add `--discover` flag: only run discovery (list projects), don't compare
       - Calls discoverProjects or compareProjects accordingly
       - Formats output with formatCompare / formatDiscovery

    2. Create `src/formatters/compare.ts`:
       - `formatDiscovery(result: WorkspaceScan, json: boolean): string`
         - Table: list of projects with checkmarks for CLAUDE.md, .claude/, .mcp.json
         - Summary: "N projects found, N with config"
       - `formatCompare(result: ComparisonResult, json: boolean): string`
         - Table: columns = project names, rows = config keys
         - Use checkmarks/X for boolean presence, truncated values for settings
         - Group by type (Settings, MCP, Hooks, Permissions, Memory)
         - Highlight differences (where projects disagree)
       - JSON format: pass through result objects

    3. Update `src/formatters/index.ts`:
       - Export `formatDiscovery` and `formatCompare`

    4. Add API endpoints in `src/server/routes.ts`:
       - `GET /api/projects?dir=<parent-dir>` — runs discoverProjects, returns JSON
       - `GET /api/compare?projects=<path1>,<path2>` — runs compareProjects, returns JSON
       Note: These endpoints take query params since they need user-provided paths.

    5. Update `src/index.ts`:
       - Import and register `compareCommand`

    Design notes:
    - Discovery is fast (just file existence checks), comparison is slower (full scan per project)
    - CLI should show a spinner or progress indicator for comparison of many projects
    - Follow existing command pattern: parse args → resolve → format → stdout.write
    - For API: validate that paths exist before scanning (return 400 for bad paths)
  </action>
  <verify>
    `npm run build` succeeds.
    `node dist/index.js compare --discover <parent-dir>` lists discovered projects.
    `node dist/index.js compare <project1> <project2>` shows comparison table.
    `node dist/index.js compare --json <parent-dir>` produces valid JSON.
    API `/api/projects?dir=...` returns project list.
    API `/api/compare?projects=...` returns comparison data.
  </verify>
  <done>
    CLI `compare` command discovers and compares projects.
    API endpoints expose discovery and comparison data for dashboard.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] Discovery finds projects with Claude Code config under a parent directory
- [ ] Comparison shows side-by-side differences between projects
- [ ] CLI `compare` works with both discovery and direct comparison modes
- [ ] API endpoints return valid JSON
- [ ] Handles edge cases: empty directory, single project, no config found
</verification>

<success_criteria>
- All tasks completed
- Project discovery works for parent directories with mixed content
- Comparison accurately shows differences across projects
- Both CLI and API work
</success_criteria>

<output>
After completion, create `.planning/phases/05-advanced-features/05-03-SUMMARY.md`
</output>
