---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/index.ts
  - src/commands/scan.ts
  - src/commands/status.ts
  - src/formatters/index.ts
  - src/formatters/table.ts
  - src/formatters/json.ts
autonomous: true

must_haves:
  truths:
    - "Running `claude-ctl scan` lists all config file locations with scope and status"
    - "Running `claude-ctl status` shows summary counts of configured vs missing files"
    - "`claude-ctl scan --json` produces valid parseable JSON to stdout"
    - "`claude-ctl status --json` produces valid parseable JSON to stdout"
    - "Output is clean when piped (no ANSI escape codes)"
    - "Running `claude-ctl --help` shows available commands"
  artifacts:
    - path: "src/index.ts"
      provides: "CLI entry point with Commander.js program"
      contains: "commander"
      min_lines: 15
    - path: "src/commands/scan.ts"
      provides: "scan command implementation"
      exports: ["scanCommand"]
    - path: "src/commands/status.ts"
      provides: "status command implementation"
      exports: ["statusCommand"]
    - path: "src/formatters/table.ts"
      provides: "Human-readable table output"
      min_lines: 20
    - path: "src/formatters/json.ts"
      provides: "JSON output formatter"
  key_links:
    - from: "src/index.ts"
      to: "src/commands/scan.ts"
      via: "Commander registers scan command"
      pattern: "scanCommand"
    - from: "src/index.ts"
      to: "src/commands/status.ts"
      via: "Commander registers status command"
      pattern: "statusCommand"
    - from: "src/commands/scan.ts"
      to: "src/scanner/index.ts"
      via: "scan command calls scanner engine"
      pattern: "scan\\("
    - from: "src/commands/scan.ts"
      to: "src/formatters"
      via: "scan command formats output"
      pattern: "format"
---

<objective>
Wire up the CLI framework with Commander.js, implement scan and status commands, and build output formatters for both human-readable and JSON output.

Purpose: This makes the scanning engine usable via the `claude-ctl` command. Users can run `claude-ctl scan` to see their config files and `claude-ctl status` for a summary.
Output: Working CLI with two commands (scan, status) and two output modes (table, JSON).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-01-SUMMARY.md

@src/scanner/types.ts
@src/scanner/index.ts
@src/scanner/paths.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Set up Commander.js CLI with scan and status commands</name>
  <files>src/index.ts, src/commands/scan.ts, src/commands/status.ts</files>
  <action>
    1. Update `src/index.ts` to be the CLI entry point:
       - Import Commander's `program`
       - Set name("claude-ctl"), version (from package.json), description
       - Add global option: `--json` (boolean, default false) for JSON output
       - Register scan and status commands
       - Call `program.parse()`

    2. Create `src/commands/scan.ts`:

       Export function that registers the scan command on program.

       Command: `claude-ctl scan [project-dir]`
       - project-dir is optional, defaults to process.cwd()
       - Calls `scan(projectDir)` from scanner
       - If `--json` flag: output JSON formatter result
       - Otherwise: output table formatter result

       Table output should show:
       ```
       Claude Code Configuration Files
       ================================

       Scope      Type        Path                              Status
       ─────      ────        ────                              ──────
       user       settings    ~/.claude/settings.json           ✓ Found
       user       keybindings ~/.claude/keybindings.json        ✗ Missing
       project    settings    .claude/settings.json             ✓ Found
       project    claude-md   CLAUDE.md                         ✓ Found
       local      settings    .claude/settings.local.json       ✗ Missing
       ```

    3. Create `src/commands/status.ts`:

       Export function that registers the status command on program.

       Command: `claude-ctl status [project-dir]`
       - project-dir is optional, defaults to process.cwd()
       - Calls `scan(projectDir)` from scanner
       - Shows summary view:

       ```
       Claude Code Configuration Status
       =================================

       Project: /path/to/project

       Found: 5 of 9 config files
       Missing: 3 files
       Errors: 1 file

       ✓ User settings          ~/.claude/settings.json
       ✓ Project settings       .claude/settings.json
       ✓ Project instructions   CLAUDE.md
       ✗ Local settings         .claude/settings.local.json (not configured)
       ✗ Keybindings           ~/.claude/keybindings.json (not configured)
       ⚠ Project commands      .claude/commands/ (permission denied)
       ```

    **Important:** Use chalk for colors, but detect when stdout is not a TTY (piped) and disable colors automatically. chalk v5 does this by default via `chalk.level` detection, but verify.
  </action>
  <verify>
    - `npm run build` succeeds
    - `node dist/index.js scan` runs and produces output
    - `node dist/index.js status` runs and produces output
    - `node dist/index.js --help` shows both commands
    - `node dist/index.js scan --json` produces valid JSON
  </verify>
  <done>Both commands work, help text displays, commands accept project-dir argument</done>
</task>

<task type="auto">
  <name>Task 2: Implement output formatters with pipe-friendly behavior</name>
  <files>src/formatters/index.ts, src/formatters/table.ts, src/formatters/json.ts</files>
  <action>
    1. Create `src/formatters/json.ts`:

       Export `formatScanJson(result: ScanResult): string`
       - JSON.stringify with 2-space indent
       - Strip any `content` field from credentials-type files (defense in depth)
       - Return clean JSON string

       Export `formatStatusJson(result: ScanResult): string`
       - Return JSON with summary + simplified file list (path, scope, status only)

    2. Create `src/formatters/table.ts`:

       Export `formatScanTable(result: ScanResult): string`
       - Column-aligned table with Scope, Type, Path, Status
       - Use chalk for colors: green ✓ for found, red ✗ for missing, yellow ⚠ for errors
       - Paths should be shortened for readability (~ for home dir)
       - Header with project dir context

       Export `formatStatusTable(result: ScanResult): string`
       - Summary counts at top
       - Grouped by scope with status icons
       - Actionable messaging for missing files (e.g., "not configured" vs "permission denied")

    3. Create `src/formatters/index.ts`:

       Export convenience functions:
       - `formatScan(result: ScanResult, json: boolean): string`
       - `formatStatus(result: ScanResult, json: boolean): string`

       These dispatch to the appropriate formatter based on the json flag.

    **Path display:**
    - Replace home directory with `~` in display paths for readability
    - Show project-relative paths for project-scope files (e.g., `.claude/settings.json` not full path)
    - Keep full paths in JSON output (for machine consumption)

    **Pipe-friendly:**
    - chalk v5 auto-detects TTY and strips colors when piped
    - JSON output should go to stdout only (no mixing with stderr)
    - Use process.stderr for any warnings/errors that shouldn't pollute piped output
  </action>
  <verify>
    - `npm run build` succeeds
    - `node dist/index.js scan` shows colored table output
    - `node dist/index.js scan --json | node -e "JSON.parse(require('fs').readFileSync('/dev/stdin','utf8'))"` — valid JSON
    - `node dist/index.js status` shows summary with icons
    - `node dist/index.js scan | cat` — no ANSI escape codes in output
  </verify>
  <done>Both output formats work, colors auto-disabled when piped, JSON is valid and parseable</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run typecheck` passes
- [ ] `claude-ctl scan` discovers and lists config files correctly
- [ ] `claude-ctl status` shows accurate summary
- [ ] `claude-ctl scan --json` produces valid JSON
- [ ] `claude-ctl status --json` produces valid JSON
- [ ] `claude-ctl --help` shows commands and options
- [ ] Output is clean when piped (no ANSI codes)
- [ ] `npx .` or `node dist/index.js` works as expected
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Both commands produce accurate output
- JSON output is valid and machine-parseable
- No ANSI codes leak into piped output
- CLI is usable via `node dist/index.js` (and will work as `claude-ctl` after npm link/install)
  </success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
