---
phase: 13-settings-toggles
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/settings/writer.ts, src/server/routes.ts, dashboard/src/lib/api.ts, dashboard/src/pages/SettingsPage.tsx]
autonomous: true

must_haves:
  truths:
    - "Boolean settings display a toggle switch on the settings page"
    - "Clicking the toggle writes the new value to user-scope settings.json only"
    - "After toggling, the settings list refreshes and shows the updated value immediately"
    - "Non-boolean settings do not show a toggle switch"
    - "User-scope settings.json is created if it doesn't exist"
    - "Managed-scope settings cannot be toggled (toggle is disabled or absent)"
  artifacts:
    - path: "src/settings/writer.ts"
      provides: "setSetting function for writing to user-scope settings.json"
      contains: "setSetting"
    - path: "src/server/routes.ts"
      provides: "POST /api/settings/set endpoint"
      contains: "settings/set"
    - path: "dashboard/src/lib/api.ts"
      provides: "setSetting fetch function"
      contains: "setSetting"
    - path: "dashboard/src/pages/SettingsPage.tsx"
      provides: "Toggle switch UI for boolean settings"
      contains: "toggle"
  key_links:
    - from: "dashboard/src/pages/SettingsPage.tsx"
      to: "dashboard/src/lib/api.ts"
      via: "setSetting() call on toggle change"
      pattern: "setSetting"
    - from: "dashboard/src/lib/api.ts"
      to: "POST /api/settings/set"
      via: "fetch call"
      pattern: "settings/set"
    - from: "src/server/routes.ts"
      to: "src/settings/writer.ts"
      via: "setSetting() import and call"
      pattern: "setSetting"
    - from: "src/settings/writer.ts"
      to: "~/.claude/settings.json"
      via: "fs.writeFile after jsonc-parser modify"
      pattern: "writeFile"
---

<objective>
Add boolean setting toggle capability — backend writer, API endpoint, and dashboard toggle switches.

Purpose: Final write capability in v1.1. Users can toggle boolean settings (true/false) from the dashboard, writing to user-scope settings.json only.
Output: setSetting() function, POST /api/settings/set endpoint, and toggle switches on SettingsPage.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/permissions/writer.ts
@src/settings/types.ts
@src/settings/resolver.ts
@src/server/routes.ts
@dashboard/src/lib/api.ts
@dashboard/src/pages/SettingsPage.tsx
@src/scanner/paths.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add setSetting() backend function and API endpoint</name>
  <files>src/settings/writer.ts, src/server/routes.ts, dashboard/src/lib/api.ts</files>
  <action>
    **1. Create `src/settings/writer.ts`:**

    New file exporting a single function:

    ```typescript
    export async function setSetting(
      key: string,
      value: unknown
    ): Promise<{ key: string; value: unknown }>
    ```

    Implementation — follow the same jsonc-parser pattern as `src/permissions/writer.ts` addPermission():

    a. **Validate inputs:**
       - key must be non-empty string after trimming
       - Throw descriptive error on invalid input

    b. **Determine user-scope settings path.** Use `path.join(os.homedir(), ".claude", "settings.json")` — same as addPermission().

    c. **Read existing file or start with empty object:**
       - Try to read the user-scope settings.json
       - If file doesn't exist, start with `"{}"` as the text content

    d. **Use jsonc-parser `modify()` to set the value:**
       - `modify(text, [key], value, { formattingOptions: { tabSize: 2, insertSpaces: true } })`
       - Apply edits with `applyEdits()`
       - This handles both creating new keys and updating existing ones

    e. **Ensure directory exists:** `fs.mkdir(dirPath, { recursive: true })` before writing.

    f. **Write file:** `fs.writeFile()` with UTF-8 encoding.

    g. **Return:** `{ key, value }`

    Imports needed: `fs` from "node:fs/promises", `os` from "node:os", `path` from "node:path", `{ modify, applyEdits }` from "jsonc-parser".

    **2. Add POST `/api/settings/set` endpoint to `src/server/routes.ts`:**

    Add the route after the existing GET `/api/settings` endpoint:

    ```typescript
    app.post("/api/settings/set", async (c) => {
      const body = await c.req.json();
      const { key, value } = body;

      if (!key || typeof key !== "string") {
        return c.json({ error: "key is required" }, 400);
      }
      if (value === undefined) {
        return c.json({ error: "value is required" }, 400);
      }

      try {
        const result = await setSetting(key.trim(), value);
        return c.json({ success: true, ...result });
      } catch (err) {
        const msg = err instanceof Error ? err.message : "Failed to set setting";
        return c.json({ error: msg }, 500);
      }
    });
    ```

    Import `setSetting` from the writer module at the top of routes.ts: `import { setSetting } from "../settings/writer.js";`

    **3. Add `setSetting()` fetch function to `dashboard/src/lib/api.ts`:**

    ```typescript
    export async function setSetting(
      key: string,
      value: unknown
    ): Promise<{ success: boolean; key: string; value: unknown }> {
      const response = await fetch("/api/settings/set", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ key, value }),
      });
      if (!response.ok) {
        const body = await response.json().catch(() => ({}));
        throw new Error(
          (body as { error?: string }).error ?? `Failed to set setting (${response.status})`
        );
      }
      return response.json() as Promise<{ success: boolean; key: string; value: unknown }>;
    }
    ```
  </action>
  <verify>npm run build succeeds. POST /api/settings/set endpoint exists in compiled output.</verify>
  <done>setSetting() writes to user-scope settings.json via jsonc-parser. API endpoint validates and proxies. Dashboard fetch function ready for UI.</done>
</task>

<task type="auto">
  <name>Task 2: Add toggle switches to SettingsPage for boolean settings</name>
  <files>dashboard/src/pages/SettingsPage.tsx</files>
  <action>
    Modify the SettingsPage to show toggle switches for boolean settings.

    **Identifying toggle-eligible settings:**
    A setting is toggle-eligible when:
    - `typeof setting.effectiveValue === "boolean"` — the effective value is a boolean
    - The setting is NOT from managed scope exclusively (managed scope should not be togglable since the write goes to user scope, but if a managed scope sets it and user scope can override, the toggle writes the override)

    Actually, ALL boolean settings should be toggleable. If a managed-scope boolean is `true`, the user can override it to `false` by writing to user scope. The toggle always writes to user-scope. The only caveat is informational: if the effective scope is managed, toggling creates a user-scope override (which may or may not take effect depending on Claude Code's internal logic — but from our side, we write to user scope).

    **Toggle component:**
    Create a small inline `ToggleSwitch` component inside SettingsPage.tsx (no separate file needed):

    ```typescript
    function ToggleSwitch({
      checked,
      onChange,
      disabled,
    }: {
      checked: boolean;
      onChange: (newValue: boolean) => void;
      disabled?: boolean;
    }) {
      return (
        <button
          type="button"
          role="switch"
          aria-checked={checked}
          disabled={disabled}
          onClick={() => onChange(!checked)}
          className={`relative inline-flex h-5 w-9 shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1 ${
            checked ? "bg-blue-600" : "bg-slate-300"
          } ${disabled ? "opacity-50 cursor-not-allowed" : ""}`}
        >
          <span
            className={`pointer-events-none inline-block h-4 w-4 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out ${
              checked ? "translate-x-4" : "translate-x-0"
            }`}
          />
        </button>
      );
    }
    ```

    **Modify SettingRow component:**

    Add state for toggle operations:
    ```typescript
    const [toggling, setToggling] = useState(false);
    ```

    In the SettingRow render, add the toggle switch between the value display and the scope badge. Only show for boolean settings:

    ```typescript
    {typeof setting.effectiveValue === "boolean" && (
      <span className="shrink-0" onClick={(e) => e.stopPropagation()}>
        <ToggleSwitch
          checked={setting.effectiveValue}
          disabled={toggling}
          onChange={async (newVal) => {
            setToggling(true);
            try {
              await setSetting(setting.key, newVal);
              triggerRefresh();
            } catch {
              // silently fail — the refresh will show original value
            } finally {
              setToggling(false);
            }
          }}
        />
      </span>
    )}
    ```

    The `e.stopPropagation()` prevents the toggle click from expanding/collapsing the row.

    **Pass `triggerRefresh` to SettingRow:**
    - SettingRow currently only receives `{ setting }` prop
    - Add `triggerRefresh` prop: `function SettingRow({ setting, triggerRefresh }: { setting: ResolvedSetting; triggerRefresh: () => void })`
    - Pass it from the parent: `<SettingRow key={setting.key} setting={setting} triggerRefresh={triggerRefresh} />`

    **Import `setSetting` from api.ts:**
    Add `setSetting` to the existing import from `"../lib/api"`.

    **Info note:** Add a small note below the settings table (next to the existing count text):
    - "Boolean settings can be toggled. Changes write to user-scope (~/.claude/settings.json)."
    - Style: `text-xs text-slate-400`
    - Only show this note when there are boolean settings visible

    **Non-boolean settings:** Leave them exactly as-is. No toggle, no change in display.

    **Styling conventions:** Follow existing SettingsPage patterns — same colors, same spacing. The toggle should be small (h-5 w-9) to fit in the row without changing the layout significantly.
  </action>
  <verify>npm run build succeeds. SettingsPage renders toggle switches for boolean settings. Toggle click fires API call.</verify>
  <done>SettingsPage shows toggle switches for boolean settings. Toggling writes to user-scope settings.json and refreshes the settings list immediately. Non-boolean settings unchanged.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm test` passes (no regressions)
- [ ] POST /api/settings/set endpoint exists and validates inputs
- [ ] setSetting() in writer.ts creates settings.json if missing
- [ ] setSetting() writes top-level key via jsonc-parser modify
- [ ] Dashboard toggle switches visible for boolean settings only
- [ ] Toggle click calls API and refreshes list
- [ ] Non-boolean settings display unchanged
- [ ] Existing settings read/display functionality still works
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Boolean settings can be toggled from the dashboard
- Toggles write to user-scope settings.json only
- Toggled settings appear immediately in settings list
- Non-boolean settings are unaffected
- Existing remove permission functionality still works
  </success_criteria>

<output>
After completion, create `.planning/phases/13-settings-toggles/13-01-SUMMARY.md`
</output>
