---
phase: 03-config-viewers-mcp-hooks-permissions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/scanner/paths.ts
  - src/mcp/types.ts
  - src/mcp/resolver.ts
  - src/commands/mcp.ts
  - src/formatters/mcp.ts
  - src/formatters/index.ts
  - src/index.ts
autonomous: true

must_haves:
  truths:
    - "User can see all MCP servers listed with name, type (command/http), and scope"
    - "MCP server details show command/args for command type and URL for http type"
    - "Secrets in headers and env vars are masked (not shown in plain text)"
    - "Duplicate server names across scopes are flagged with warning"
    - "--json output includes all MCP server data in machine-readable format"
  artifacts:
    - path: "src/mcp/types.ts"
      provides: "McpServer and McpResult type definitions"
      exports: ["McpServer", "McpResult"]
    - path: "src/mcp/resolver.ts"
      provides: "MCP server extraction, secret masking, duplicate detection"
      exports: ["extractMcpServers"]
    - path: "src/commands/mcp.ts"
      provides: "CLI mcp command with list mode"
      exports: ["mcpCommand"]
    - path: "src/formatters/mcp.ts"
      provides: "Table and JSON formatters for MCP data"
      exports: ["formatMcpTable", "formatMcpJson"]
  key_links:
    - from: "src/commands/mcp.ts"
      to: "src/mcp/resolver.ts"
      via: "extractMcpServers() call"
      pattern: "extractMcpServers"
    - from: "src/commands/mcp.ts"
      to: "src/formatters/mcp.ts"
      via: "formatMcp dispatch"
      pattern: "formatMcp"
    - from: "src/mcp/resolver.ts"
      to: "scan result files"
      via: "filters ConfigFile[] for type=mcp"
      pattern: "f\\.type.*mcp"
---

<objective>
Implement `claude-ctl mcp` command that lists all configured MCP servers across scopes with details display, secret masking, and duplicate detection.

Purpose: Give users visibility into all MCP servers configured at user and project levels, with masked secrets and duplicate warnings (MCP-01, MCP-02, MCP-03).
Output: Working `mcp` command with table and JSON output, new .mcp.json scanner paths.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/scanner/types.ts
@src/scanner/paths.ts
@src/scanner/index.ts
@src/commands/settings.ts
@src/formatters/index.ts
@src/formatters/table.ts
@src/formatters/json.ts
@src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add .mcp.json scanner paths + MCP types + resolver</name>
  <files>src/scanner/paths.ts, src/mcp/types.ts, src/mcp/resolver.ts</files>
  <action>
    **1. Add .mcp.json paths to scanner** (`src/scanner/paths.ts`):
    Add two new expectations for MCP config files:
    - Project-level: `path.join(projectDir, ".mcp.json")` with scope "project", type "mcp", description "Project-level MCP server configuration"
    - The project .mcp.json goes at project root (NOT inside .claude/), only when projectDir is provided

    **2. Create MCP types** (`src/mcp/types.ts`):
    ```typescript
    export interface McpServer {
      name: string;           // Server key name (e.g., "context7", "github")
      scope: ConfigScope;     // Where it was found
      sourcePath: string;     // Which file it came from
      type: "command" | "http"; // Determined from config structure
      command?: string;       // For command-based servers
      args?: string[];        // For command-based servers
      url?: string;           // For http-based servers
      headers?: Record<string, string>; // For http-based (secrets masked)
      env?: Record<string, string>;     // Environment variables (secrets masked)
    }

    export interface McpDuplicate {
      name: string;
      locations: Array<{ scope: ConfigScope; sourcePath: string }>;
    }

    export interface McpResult {
      servers: McpServer[];
      duplicates: McpDuplicate[];
    }
    ```

    **3. Create MCP resolver** (`src/mcp/resolver.ts`):
    Export `extractMcpServers(files: ConfigFile[]): McpResult`

    Logic:
    a. Filter ConfigFile[] for type === "mcp" with exists && readable && content
    b. For each file, parse the content object. Handle TWO formats:
       - **Direct format**: `{ "serverName": { command, args } }` — keys at root are server names
       - **Wrapped format**: `{ "mcpServers": { "serverName": { type, url } } }` — servers under mcpServers key
       Detection: if content has a `mcpServers` key that is an object, use wrapped format. Otherwise treat all top-level keys as servers.
    c. For each server entry, determine type:
       - If has `command` field → type "command"
       - If has `type: "http"` or has `url` field → type "http"
    d. Mask secrets: for `headers` values, replace any string containing `$\{` or starting with `sk-` or `Bearer` with `***`. For `env` values, mask all values as `***`.
    e. Detect duplicates: group servers by name, flag any name appearing in 2+ files.
    f. Return McpResult with servers sorted by scope priority (project first), then name.

    Also extract from settings.json files: filter for type === "settings" with content, check if content has `mcpServers` key, extract servers from there too with the file's scope.

    Use ConfigScope import from scanner types.
  </action>
  <verify>npx tsc --noEmit passes with no errors on the new files</verify>
  <done>Scanner discovers .mcp.json files, MCP types defined, resolver extracts servers from both .mcp.json and settings.json with secret masking and duplicate detection</done>
</task>

<task type="auto">
  <name>Task 2: MCP command + formatters</name>
  <files>src/commands/mcp.ts, src/formatters/mcp.ts, src/formatters/index.ts, src/index.ts</files>
  <action>
    **1. Create MCP formatters** (`src/formatters/mcp.ts`):

    `formatMcpTable(result: McpResult, projectDir: string | null): string`
    - Title: "MCP Servers" with chalk.bold
    - Table with columns: Name, Type, Scope, Details
    - For "command" type, Details = command + args joined (e.g., "npx -y @upstash/context7-mcp")
    - For "http" type, Details = url
    - If headers exist, show masked headers below details indented
    - After server list, if duplicates exist, show warning section:
      "⚠ Duplicate servers:" with each duplicate's name and where it appears
    - Empty state: "No MCP servers configured."
    - Footer: "{N} server(s) configured"
    - Use shortenPath helper (import from table.ts or replicate the home→~ logic)

    `formatMcpJson(result: McpResult): string`
    - JSON.stringify the McpResult with indent 2

    **2. Create MCP command** (`src/commands/mcp.ts`):
    Follow exact pattern from settings command:
    - `program.command("mcp [project-dir]")`
    - `.description("List all configured MCP servers with details and duplicate detection")`
    - Action: scan(dir), call extractMcpServers(result.files), format with formatMcp dispatch
    - Output via process.stdout.write

    **3. Add dispatch to formatters/index.ts**:
    - Import formatMcpTable, formatMcpJson from "./mcp.js"
    - Add `formatMcp(result: McpResult, projectDir: string | null, json: boolean): string` dispatch function
    - Re-export formatMcpTable, formatMcpJson

    **4. Register command in src/index.ts**:
    - Import mcpCommand from "./commands/mcp.js"
    - Call mcpCommand(program) alongside other registrations

    Follow established patterns exactly:
    - Command registration pattern (exported function takes program)
    - Formatter dispatch pattern (formatX routes to table/json)
    - Output via process.stdout.write (not console.log)
  </action>
  <verify>npm run build succeeds && node dist/index.js mcp --help shows usage && node dist/index.js mcp --json outputs valid JSON (even if no servers found)</verify>
  <done>`claude-ctl mcp` lists MCP servers with details, masked secrets, and duplicate warnings. Both table and --json output work.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npx tsc --noEmit` passes
- [ ] `claude-ctl mcp` runs without error (shows "No MCP servers" or found servers)
- [ ] `claude-ctl mcp --json` outputs valid JSON
- [ ] `claude-ctl mcp .` scans current project for .mcp.json
- [ ] `claude-ctl scan` still works (no regressions)
- [ ] Secret values in headers are masked as `***`
</verification>

<success_criteria>
- All tasks completed
- MCP servers from .mcp.json files are discovered and listed
- Both command-type and http-type servers display correctly
- Secrets in headers/env are masked
- Duplicate server names across scopes produce warnings
- Table and JSON output both work
- No regressions in existing commands
</success_criteria>

<output>
After completion, create `.planning/phases/03-config-viewers-mcp-hooks-permissions/03-01-SUMMARY.md`
</output>
