---
phase: 04-web-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/server/index.ts
  - src/server/routes.ts
  - src/commands/dashboard.ts
  - src/index.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "API returns scan results at GET /api/scan"
    - "API returns resolved settings at GET /api/settings"
    - "API returns CLAUDE.md list at GET /api/memory"
    - "API returns MCP servers at GET /api/mcp"
    - "API returns hooks at GET /api/hooks"
    - "API returns commands at GET /api/commands"
    - "API returns permissions at GET /api/permissions"
    - "claude-ctl dashboard starts a local HTTP server"
  artifacts:
    - path: "src/server/index.ts"
      provides: "Hono server setup with API routes and static file serving"
      min_lines: 30
    - path: "src/server/routes.ts"
      provides: "REST API route handlers calling existing resolvers"
      min_lines: 60
      exports: ["apiRoutes"]
    - path: "src/commands/dashboard.ts"
      provides: "CLI dashboard command that starts server and opens browser"
      min_lines: 20
      exports: ["dashboardCommand"]
  key_links:
    - from: "src/server/routes.ts"
      to: "src/scanner/index.ts"
      via: "imports scan() function"
      pattern: "import.*scan.*from.*scanner"
    - from: "src/server/routes.ts"
      to: "src/settings/resolver.ts"
      via: "imports resolveSettings()"
      pattern: "import.*resolveSettings.*from.*settings"
    - from: "src/commands/dashboard.ts"
      to: "src/server/index.ts"
      via: "imports and starts the server"
      pattern: "import.*from.*server"
    - from: "src/index.ts"
      to: "src/commands/dashboard.ts"
      via: "registers dashboard command"
      pattern: "dashboardCommand"
---

<objective>
Set up Hono web server with REST API exposing all scanner/resolver data, and add `dashboard` CLI command.

Purpose: Provide the data layer and server infrastructure that the React dashboard will consume. All existing resolver logic (settings, MCP, hooks, permissions) is reused via API routes.
Output: Working API server at localhost:3737 with all endpoints returning JSON, `claude-ctl dashboard` command to start it.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/index.ts
@src/scanner/index.ts
@src/scanner/types.ts
@src/settings/resolver.ts
@src/settings/types.ts
@src/mcp/resolver.ts
@src/mcp/types.ts
@src/hooks/resolver.ts
@src/hooks/types.ts
@src/permissions/resolver.ts
@src/permissions/types.ts
@src/commands/settings.ts
@src/commands/memory.ts
@package.json
@tsup.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Hono server with REST API routes</name>
  <files>src/server/index.ts, src/server/routes.ts, package.json</files>
  <action>
    1. Install production dependencies: `hono` and `@hono/node-server`
    2. Create `src/server/routes.ts` — a Hono router with these API endpoints:
       - `GET /api/scan` — calls `scan(projectDir)`, returns full ScanResult as JSON
       - `GET /api/status` — calls `scan(projectDir)`, returns `result.summary` as JSON
       - `GET /api/settings` — calls `scan(projectDir)`, filters settings files, calls `resolveSettings()`, returns SettingsResult as JSON
       - `GET /api/memory` — calls `scan(projectDir)`, filters claude-md files with exists===true, returns array of {scope, path, sizeBytes, content} as JSON
       - `GET /api/mcp` — calls `scan(projectDir)`, calls `extractMcpServers(files)`, returns McpResult as JSON
       - `GET /api/hooks` — calls `scan(projectDir)`, calls `extractHooks()` on settings files, returns HooksResult as JSON
       - `GET /api/commands` — calls `scan(projectDir)`, calls `extractCommands()`, returns CommandsResult as JSON
       - `GET /api/permissions` — calls `scan(projectDir)`, calls `resolvePermissions(files)`, returns PermissionsResult as JSON

       The projectDir should be stored as module-level state set by the server startup code (see server/index.ts). Export a `setProjectDir(dir: string)` function for this.

       Follow the same data extraction pattern used in the CLI commands (see src/commands/settings.ts for the scan → filter → resolve pattern). Each route should reuse the existing resolver logic — do NOT duplicate data extraction.

    3. Create `src/server/index.ts` — server setup:
       - Export `startServer(options: { port: number; projectDir: string; dashboardDir: string })` function
       - Create Hono app, mount API routes from routes.ts
       - Add static file serving for the dashboard SPA using `serveStatic` from `@hono/node-server/serve-static` at `/*` path, with root pointing to dashboardDir
       - Add SPA fallback: any GET request not matching /api/* or a static file should return the dashboard's index.html (read with fs.readFileSync at startup, serve with c.html())
       - Start server with `serve()` from `@hono/node-server` on the configured port
       - Return the server instance for graceful shutdown
       - Add CORS middleware from `hono/cors` for development flexibility

    Important: Use `import.meta.url` + `fileURLToPath` to resolve __dirname in ESM. The dashboardDir path will be passed in from the CLI command.
  </action>
  <verify>
    npm run build succeeds (TypeScript compiles without errors).
    Manually verify: `node dist/index.js dashboard` starts server (will show "dashboard not found" for static files since React isn't built yet, but API routes should respond).
    curl http://localhost:3737/api/status returns JSON with summary counts.
  </verify>
  <done>
    All 8 API endpoints return correct JSON data from existing resolvers.
    Server starts and listens on configured port.
    CORS enabled for development.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add dashboard CLI command</name>
  <files>src/commands/dashboard.ts, src/index.ts</files>
  <action>
    1. Create `src/commands/dashboard.ts` following the established command registration pattern:
       - Command: `claude-ctl dashboard [project-dir]`
       - Options:
         - `--port <number>` (default: 3737) — port to serve on
         - `--no-open` — skip auto-opening the browser
       - Action handler:
         a. Resolve projectDir (default to process.cwd())
         b. Resolve dashboardDir: `path.join(path.dirname(fileURLToPath(import.meta.url)), 'dashboard')` — this points to `dist/dashboard/` at runtime
         c. Call `startServer({ port, projectDir, dashboardDir })` from server/index.ts
         d. Log: `Dashboard running at http://localhost:{port}` (use process.stderr.write so it doesn't pollute piped output)
         e. If --open (default true): use dynamic import of `open` package OR use `child_process.exec` with platform-specific browser open command (Windows: `start`, macOS: `open`, Linux: `xdg-open`). Prefer child_process.exec to avoid adding another dependency.
         f. Handle SIGINT for graceful shutdown: close server, log "Dashboard stopped", exit 0
    2. Register in `src/index.ts`: import `dashboardCommand` and call `dashboardCommand(program)` alongside existing commands.
  </action>
  <verify>
    npm run build succeeds.
    `node dist/index.js dashboard --no-open` starts server, prints URL to stderr, serves API routes.
    `node dist/index.js dashboard --port 4000 --no-open` uses custom port.
    Ctrl+C stops the server cleanly.
  </verify>
  <done>
    `claude-ctl dashboard` starts server and opens browser.
    `--port` and `--no-open` options work correctly.
    Graceful shutdown on SIGINT.
    Command registered alongside existing 8 commands.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without TypeScript errors
- [ ] `node dist/index.js --help` shows dashboard command in help text
- [ ] `node dist/index.js dashboard --no-open` starts server on port 3737
- [ ] `curl http://localhost:3737/api/scan` returns valid JSON ScanResult
- [ ] `curl http://localhost:3737/api/settings` returns valid JSON SettingsResult
- [ ] `curl http://localhost:3737/api/mcp` returns valid JSON McpResult
- [ ] `curl http://localhost:3737/api/hooks` returns valid JSON HooksResult
- [ ] `curl http://localhost:3737/api/permissions` returns valid JSON PermissionsResult
- [ ] `curl http://localhost:3737/api/memory` returns valid JSON array of CLAUDE.md files
- [ ] Server responds to Ctrl+C with clean shutdown
</verification>

<success_criteria>
- All tasks completed
- All 8 API endpoints return correct data from existing resolvers
- Dashboard command starts server with port and open options
- No new TypeScript errors or warnings
- Existing CLI commands still work (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/04-web-dashboard/04-01-SUMMARY.md`
</output>
