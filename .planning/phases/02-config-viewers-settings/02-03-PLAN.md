---
phase: 02-config-viewers-settings
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/commands/settings.ts
  - src/formatters/table.ts
  - src/formatters/json.ts
  - src/formatters/index.ts
  - src/index.ts
autonomous: true

must_haves:
  truths:
    - "`claude-ctl settings` shows all setting values with their source scope and file path"
    - "User can see which scope level wins when the same setting exists at multiple levels"
    - "Override chain is visible for settings defined at multiple scopes"
    - "`claude-ctl settings --json` produces valid JSON with override details"
  artifacts:
    - path: "src/commands/settings.ts"
      provides: "Settings command registration"
      exports: ["settingsCommand"]
      min_lines: 30
    - path: "src/formatters/table.ts"
      provides: "formatSettingsTable function"
      contains: "formatSettingsTable"
    - path: "src/formatters/json.ts"
      provides: "formatSettingsJson function"
      contains: "formatSettingsJson"
  key_links:
    - from: "src/commands/settings.ts"
      to: "src/settings/resolver.ts"
      via: "imports resolveSettings to compute merged settings"
      pattern: "resolveSettings"
    - from: "src/commands/settings.ts"
      to: "scan()"
      via: "calls scan() to get raw settings files from all scopes"
      pattern: "scan\\("
    - from: "src/index.ts"
      to: "src/commands/settings.ts"
      via: "registers settingsCommand on Commander program"
---

<objective>
Create the settings command that wires the resolver (from Plan 02-01) to the CLI with table and JSON formatters showing the override chain.

Purpose: Users need to see all their Claude Code settings in one place, with clear indication of which scope level each value comes from and which value "wins" when the same setting exists at multiple levels.
Output: Working `claude-ctl settings` command with override chain display.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Need resolver types and function from Plan 02-01
@.planning/phases/02-config-viewers-settings/02-01-SUMMARY.md

@src/scanner/types.ts
@src/scanner/index.ts
@src/commands/scan.ts
@src/formatters/index.ts
@src/formatters/table.ts
@src/formatters/json.ts
@src/index.ts
@src/settings/types.ts
@src/settings/resolver.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create settings command wiring resolver to CLI</name>
  <files>src/commands/settings.ts, src/index.ts</files>
  <action>
    1. Create src/commands/settings.ts following the command-registration pattern:
       - Command: `claude-ctl settings [project-dir]`
       - Options:
         - `--key <name>`: Filter to show only a specific setting key (optional)
       - Action handler:
         a. Run scan(dir) to get all config files
         b. Filter for type === "settings" files that exist and have content
         c. Map each settings ConfigFile to ScopedSettings: { scope, path: expectedPath, settings: content as Record }
         d. Call resolveSettings(scopedSettings) to get merged result
         e. If --key provided, filter result to matching key(s) (substring match)
         f. Format and display using formatSettings(result, json)
       - Import resolveSettings from "../settings/resolver.js"
       - Import formatSettings from "../formatters/index.js"

    2. In src/index.ts, import and register settingsCommand:
       - import { settingsCommand } from "./commands/settings.js"
       - settingsCommand(program)
       - Place it after statusCommand registration
  </action>
  <verify>npm run build succeeds, npm run typecheck passes</verify>
  <done>Settings command registered and wired to resolver, scans settings from all scopes and produces merged result</done>
</task>

<task type="auto">
  <name>Task 2: Create settings formatters with override chain display</name>
  <files>src/formatters/table.ts, src/formatters/json.ts, src/formatters/index.ts</files>
  <action>
    1. In src/formatters/table.ts, add formatSettingsTable function:
       - Input: SettingsResult, projectDir: string | null
       - Output: formatted string
       - Display:
         - Header: "Claude Code Settings" (chalk.bold)
         - If no settings found: "No settings configured."
         - For each ResolvedSetting:
           - Key name in bold/cyan
           - Effective value (JSON.stringify for objects, raw for primitives)
           - Source: "from [scope] ([shortened path])" in dim text
           - If overrides.length > 1: show override chain below the setting
             - Each overridden value: "  ├ [scope]: [value] ([path])" in dim
             - Use dim/strikethrough or dim color for overridden values
             - Mark the winning value with chalk.green
         - Use shortenPath() for path display
         - Separate settings with blank lines for readability

    2. In src/formatters/json.ts, add formatSettingsJson function:
       - Input: SettingsResult
       - Output: JSON string
       - Structure: { settings: ResolvedSetting[] } — direct serialization of SettingsResult
       - Paths are full (not shortened) for machine consumption

    3. In src/formatters/index.ts, add formatSettings dispatch function:
       - formatSettings(result: SettingsResult, projectDir: string | null, json: boolean): string
       - Route to formatSettingsTable or formatSettingsJson
       - Add re-exports
       - Import SettingsResult type from settings/types.ts
  </action>
  <verify>npm run build succeeds, npm run typecheck passes</verify>
  <done>Settings formatters show effective values with scope source and override chain in both table and JSON modes</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] `npm run typecheck` passes
- [ ] `claude-ctl settings` shows settings with scope and source file
- [ ] Override chain visible when same setting exists at multiple levels
- [ ] `claude-ctl settings --json` produces valid JSON
- [ ] `claude-ctl settings --key <name>` filters to matching key
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Settings command follows established patterns
- Override chain clearly shows which scope wins
- No errors or warnings introduced
</success_criteria>

<output>
After completion, create `.planning/phases/02-config-viewers-settings/02-03-SUMMARY.md`
</output>
