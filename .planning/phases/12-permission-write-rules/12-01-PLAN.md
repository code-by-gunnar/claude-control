---
phase: 12-permission-write-rules
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/permissions/writer.ts, src/server/routes.ts, dashboard/src/lib/api.ts, dashboard/src/pages/PermissionsPage.tsx]
autonomous: true

must_haves:
  truths:
    - "User can see an Add Rule form on the permissions page"
    - "User can enter a tool name, optional pattern, and select allow/deny/ask"
    - "Submitting the form writes the rule to user-scope settings.json only"
    - "Added rule appears in the permissions list without page reload"
    - "User-scope settings.json is created if it doesn't exist"
    - "Managed-scope files are never written to"
  artifacts:
    - path: "src/permissions/writer.ts"
      provides: "addPermission function alongside existing removePermission"
      contains: "addPermission"
    - path: "src/server/routes.ts"
      provides: "POST /api/permissions/add endpoint"
      contains: "permissions/add"
    - path: "dashboard/src/lib/api.ts"
      provides: "addPermission fetch function"
      contains: "addPermission"
    - path: "dashboard/src/pages/PermissionsPage.tsx"
      provides: "Add rule form UI with tool, pattern, rule inputs"
      contains: "Add Rule"
  key_links:
    - from: "dashboard/src/pages/PermissionsPage.tsx"
      to: "dashboard/src/lib/api.ts"
      via: "addPermission() call on form submit"
      pattern: "addPermission"
    - from: "dashboard/src/lib/api.ts"
      to: "POST /api/permissions/add"
      via: "fetch call"
      pattern: "permissions/add"
    - from: "src/server/routes.ts"
      to: "src/permissions/writer.ts"
      via: "addPermission() import and call"
      pattern: "addPermission"
    - from: "src/permissions/writer.ts"
      to: "~/.claude/settings.json"
      via: "fs.writeFile after jsonc-parser modify"
      pattern: "writeFile"
---

<objective>
Add permission rule write capability — backend writer, API endpoint, and dashboard form.

Purpose: First write capability in claude-ctl. Users can add permission rules (allow/deny/ask) from the dashboard, writing to user-scope settings.json only.
Output: addPermission() function, POST /api/permissions/add endpoint, and "Add Rule" form on PermissionsPage.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/permissions/writer.ts
@src/permissions/types.ts
@src/server/routes.ts
@dashboard/src/lib/api.ts
@dashboard/src/pages/PermissionsPage.tsx
@src/scanner/paths.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add addPermission() backend function and API endpoint</name>
  <files>src/permissions/writer.ts, src/server/routes.ts, dashboard/src/lib/api.ts</files>
  <action>
    **1. Add `addPermission()` to `src/permissions/writer.ts`:**

    Export a new function alongside the existing `removePermission()`:

    ```typescript
    export async function addPermission(
      tool: string,
      rule: "allow" | "deny" | "ask",
      pattern?: string
    ): Promise<{ added: string }>
    ```

    Implementation — follow the same jsonc-parser pattern as removePermission():

    a. **Determine user-scope settings path.** Import the user-scope settings path from scanner/paths.ts. The user-scope settings.json lives at `~/.claude/settings.json`. Use the same path resolution as the scanner (os.homedir() + `.claude/settings.json`).

    b. **Build the permission string.** If pattern is provided: `"ToolName(pattern)"`. If not: `"ToolName"`. Trim whitespace from tool and pattern.

    c. **Validate inputs:**
       - tool must be non-empty string after trimming
       - rule must be one of "allow", "deny", "ask"
       - Throw descriptive error on invalid input

    d. **Read existing file or start with empty object:**
       - Try to read the user-scope settings.json
       - If file doesn't exist, start with `"{}"` as the text content
       - If file exists, read its contents as UTF-8 text (preserve BOM if present, same as removePermission)

    e. **Check for duplicate:** Parse the JSONC text. Check if `permissions[rule]` array already contains the exact permission string. If it does, throw error "Permission already exists".

    f. **Use jsonc-parser `modify()` to add the entry:**
       - If `permissions` key doesn't exist: `modify(text, ["permissions"], {}, formattingOptions)` to create it
       - If `permissions[rule]` array doesn't exist: `modify(text, ["permissions", rule], [], formattingOptions)` to create it
       - Then use `modify(text, ["permissions", rule, -1], permString, formattingOptions)` to append to the array (index -1 = append)
       - Apply each set of edits in sequence with `applyEdits()`
       - Use same formatting options as removePermission (`tabSize: 2, insertSpaces: true`)

    g. **Ensure directory exists:** Before writing, ensure `~/.claude/` directory exists with `fs.mkdir(dirPath, { recursive: true })`.

    h. **Write file:** Write the modified text back to the file path with `fs.writeFile()`.

    i. **Return:** `{ added: permString }`

    **2. Add POST `/api/permissions/add` endpoint to `src/server/routes.ts`:**

    Add the route near the existing `/api/permissions/remove` endpoint:

    ```typescript
    app.post("/api/permissions/add", async (c) => {
      const body = await c.req.json();
      const { tool, rule, pattern } = body;

      // Validate
      if (!tool || typeof tool !== "string") {
        return c.json({ error: "tool is required" }, 400);
      }
      if (!["allow", "deny", "ask"].includes(rule)) {
        return c.json({ error: "rule must be allow, deny, or ask" }, 400);
      }

      try {
        const result = await addPermission(tool.trim(), rule, pattern?.trim() || undefined);
        return c.json({ success: true, ...result });
      } catch (err) {
        const msg = err instanceof Error ? err.message : "Failed to add permission";
        return c.json({ error: msg }, 500);
      }
    });
    ```

    Import `addPermission` from the writer module at the top of routes.ts (alongside the existing `removePermission` import).

    **3. Add `addPermission()` fetch function to `dashboard/src/lib/api.ts`:**

    ```typescript
    export async function addPermission(
      tool: string,
      rule: string,
      pattern?: string
    ): Promise<{ success: boolean; added: string }> {
      const res = await fetch(`${BASE}/api/permissions/add`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ tool, rule, pattern: pattern || undefined }),
      });
      if (!res.ok) {
        const data = await res.json().catch(() => ({}));
        throw new Error(data.error || `Failed to add permission (${res.status})`);
      }
      return res.json();
    }
    ```
  </action>
  <verify>npm run build succeeds. POST /api/permissions/add endpoint exists in compiled output.</verify>
  <done>addPermission() writes to user-scope settings.json via jsonc-parser. API endpoint validates and proxies. Dashboard fetch function ready for UI.</done>
</task>

<task type="auto">
  <name>Task 2: Add "Add Rule" form to PermissionsPage</name>
  <files>dashboard/src/pages/PermissionsPage.tsx</files>
  <action>
    Add an "Add Rule" form section to the PermissionsPage, above the existing permissions table.

    **Form design:**

    A collapsible/toggleable form panel. Button labeled "Add Rule" with a plus icon toggles the form open/closed.

    When open, the form contains:
    - **Tool name** — text input, required. Placeholder: "e.g., Bash, Read, WebSearch". Monospace font.
    - **Pattern** — text input, optional. Placeholder: "e.g., ls *, rm -rf * (optional)". Monospace font.
    - **Rule** — select dropdown with three options: "allow", "deny", "ask". Default to "allow".
    - **Submit button** — "Add Permission" with a save/plus icon. Disabled while submitting.
    - **Cancel button** — closes the form, resets fields.

    **Form state:**
    ```typescript
    const [showAddForm, setShowAddForm] = useState(false);
    const [addTool, setAddTool] = useState("");
    const [addPattern, setAddPattern] = useState("");
    const [addRule, setAddRule] = useState<"allow" | "deny" | "ask">("allow");
    const [addSubmitting, setAddSubmitting] = useState(false);
    const [addError, setAddError] = useState<string | null>(null);
    const [addSuccess, setAddSuccess] = useState<string | null>(null);
    ```

    **Submit handler:**
    1. Set submitting state
    2. Clear previous error/success
    3. Call `addPermission(addTool.trim(), addRule, addPattern.trim() || undefined)` from api.ts
    4. On success:
       - Show success message (e.g., "Added: Bash(ls *) → allow")
       - Clear form fields
       - Call `triggerRefresh()` from RefreshContext to re-fetch permissions — this makes the new rule appear immediately without page reload
       - Auto-hide success message after 3 seconds
    5. On error:
       - Show error message from the API response
       - Keep form fields intact so user can correct
    6. Set submitting false

    **Layout placement:** Between the page header ("Permissions" / description) and the existing permissions table. Style the form panel with:
    - Toggle button: `bg-blue-600 text-white` pill with plus icon, right-aligned in header area
    - Form panel: `bg-white border border-slate-200 rounded-lg p-4 mb-6` when open
    - Info note below the form: "Rules are saved to user-scope settings (~/.claude/settings.json)"
    - Success feedback: green text below submit button
    - Error feedback: red text below submit button

    **Styling conventions:** Follow the existing dashboard patterns — same input styles as ProjectsPage (border-slate-300, rounded-lg, text-sm, focus:ring-2, font-mono for path/tool inputs), same button styles as elsewhere.

    **Import:** Import `addPermission` from `../lib/api` alongside the existing imports.
  </action>
  <verify>npm run build succeeds. PermissionsPage renders add form. Form submits to API endpoint.</verify>
  <done>PermissionsPage has toggleable "Add Rule" form. Submitting writes to user-scope settings.json and refreshes the permissions list immediately. Error/success feedback visible.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm test` passes (no regressions)
- [ ] POST /api/permissions/add endpoint exists and validates inputs
- [ ] addPermission() in writer.ts creates settings.json if missing
- [ ] addPermission() appends to existing permissions array via jsonc-parser
- [ ] addPermission() rejects duplicate entries
- [ ] Dashboard "Add Rule" form visible on permissions page
- [ ] Form submits tool + optional pattern + rule to API
- [ ] After successful add, permissions list refreshes automatically
- [ ] Success/error feedback displayed to user
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Permission rules can be added from the dashboard
- Rules write to user-scope settings.json only
- Added rules appear immediately in permissions list
- Existing remove functionality still works
  </success_criteria>

<output>
After completion, create `.planning/phases/12-permission-write-rules/12-01-SUMMARY.md`
</output>
